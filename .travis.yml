# file generated by gen_travis_yml.php, do not edit!

# use the container infrastructure
sudo: required

services:
  - docker

language: c
compiler:
 # gcc compiler, clang would be fine too
  - gcc


before_install:
 # What is the current file size max for core files?
 # It is usually 0, which means no core file will be dumped if there is a crash 
 - ulimit -c
 - ulimit -a -S
 - ulimit -a -H
 - cat /proc/sys/kernel/core_pattern
 - cat /etc/default/apport
 - service --status-all || true
 - initctl list || true

# use the system's PHP to run this script
addons:
  apt:
    packages:
      - php5-cli
      - php-pear
      - libxml2-dev
      - libcurl4-gnutls-dev
      - lcov

install:
  - gem install lcoveralls

# now we'll specify the build matrix environment
env:
  - PHP=5.6.37 enable_debug=no enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=7.0.33 enable_debug=no enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP==7.1.27 enable_debug=no enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=7.2.16 enable_debug=no enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=7.3.3 enable_debug=no enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=5.6.37 enable_debug=yes enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=7.0.33 enable_debug=yes enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP==7.1.27 enable_debug=yes enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=7.2.16 enable_debug=yes enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=7.3.3 enable_debug=yes enable_maintainer_zts=no enable_libxml=yes enable_json=yes
  - PHP=5.6.37 enable_debug=no enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=7.0.33 enable_debug=no enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP==7.1.27 enable_debug=no enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=7.2.16 enable_debug=no enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=7.3.3 enable_debug=no enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=5.6.37 enable_debug=yes enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=7.0.33 enable_debug=yes enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP==7.1.27 enable_debug=yes enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=7.2.16 enable_debug=yes enable_maintainer_zts=yes enable_libxml=yes enable_json=yes
  - PHP=7.3.3 enable_debug=yes enable_maintainer_zts=yes enable_libxml=yes enable_json=yes

before_script:
  # build the matrix' PHP version
  - make -f travis/pecl/Makefile php
  # build the extension, the PECL variable expects the extension name
  # and optionally the soname and a specific version of the extension
  # separeated by double colon, e.g. PECL=myext:ext:1.7.5
  - make -f travis/pecl/Makefile ext PECL=solr
  - docker pull omars/solr53
  - docker run -d --name solr53 -p 127.0.0.1:8983:8983 -t omars/solr53
  - sleep 5
  - lcov --directory . -f --zerocounters && lcov --directory . -f --capture --initial --no-external --output-file coverage.info

script:

  # install mason
       - mkdir ./mason/
       - curl -sSfL https://github.com/mapbox/mason/archive/v0.2.0.tar.gz | tar --gunzip --extract --strip-components=1 --directory=./mason/
       # install gdb via mason
       - ./mason/mason install gdb 7.12
       # put GDB on PATH
       - export PATH=$(./mason/mason prefix gdb 7.12)/bin:${PATH}
       # install logbt
       - curl -sSfL https://github.com/mapbox/logbt/archive/v1.6.0.tar.gz | tar --gunzip --extract --strip-components=2 --exclude="*md" --exclude="test*" --directory=.
       - RESULT=0
       # Compile our demo program which will crash if
       # the CRASH_PLEASE environment variable is set
       # modify corepattern for logbt
       - sudo bash -c "echo '/tmp/logbt-coredumps/core.%p.%E' > /proc/sys/kernel/core_pattern"
       # Run the program to prompt a crash
       # Note: we capture the return code of the program here and add
       # `|| true` to ensure that travis continues past the crash
       - CRASH_PLEASE=1 ./logbt make -f travis/pecl/Makefile test TESTS=tests/028.solrdocument_clone.phpt || RESULT=$?
       # For the purpose of this repo we assume the test will crash so let's
       # assert that the RESULT is 139 (exit code for a segfault)
       # For a real repo you would likely assert the RESULT is zero
       - if [[ ${RESULT} != 139 ]]; then echo "expected segfault and 139 exit but instead exited with ${RESULT}" && exit 1; fi;

after_script:
  - lcov --no-checksum --directory . -f --capture --output-file coverage.info && lcov -f --remove coverage.info "/usr/*" -o coverage.info
  - lcoveralls -r .

notifications:
  email:
    - omars@php.net
